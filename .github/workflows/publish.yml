name: Publish to PyPI

# Trigger: manually bump version in pyproject.toml, commit, then create a
# GitHub Release. This workflow tests, builds, and publishes automatically.
#
# PyPI trusted publishing (no token needed):
#   https://docs.pypi.org/trusted-publishers/
#   Configure once on PyPI: GitHub Actions > this repo > this workflow file name

on:
  release:
    types: [created]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: uv sync
      - name: Run tests
        run: uv run pytest

  publish:
    runs-on: ubuntu-latest
    needs: [test]
    environment: release
    permissions:
      id-token: write  # required for PyPI trusted publishing (OIDC)
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Build
        run: uv build
      - name: Publish to PyPI
        run: uv publish
